var request = require('request');
var Entities = require('html-entities').XmlEntities;
var entities = new Entities();

var _URL = 'http://www.reddit.com/r/askreddit.rss';


Array.prototype.shuffle = function() { //v1.0
  for(var j, x, i = this.length; i; j = Math.floor(Math.random() * i), x = this[--i], this[i] = this[j], this[j] = x);
  return this;
};


var AskRedditLib = function() {
  var self = this;

  self.getRandomQuestion = function(cb) {
    request(_URL, function (error, response, body) {
      if (!error && response.statusCode == 200) {
        // Regex, fuck yeah!
        var m = body.match(/<title>([^<]+)<\/title>*<link>([^<]+)<\/link>/g);
        
        // Shift the first two entries, then shuffle the questions and pop one
        m.shift();
        m.shift();
        m.shuffle();
        
        var rawQuestion = m.pop();
        rawQuestion = rawQuestion.substring('<title>'.length, (rawQuestion.length - '</title>'.length));
        rawQuestion = entities.decode(rawQuestion);

        var questionLink = rawQuestion.split('</title><link>');
        rawQuestion = questionLink[0];
        rawLink = questionLink[1];

        rawQuestion.replace('Reddit', 'Refudoge');
        rawQuestion.replace('reddit', 'refudoge');
        rawQuestion.replace('REDDIT', 'REFUDOGE');

        cb({
          question: rawQuestion,
          url: rawLink
        });
      }
      else {
        cb(null);
      }
    });
  };
};

module.exports = new AskRedditLib();
