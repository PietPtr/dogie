
var Pushover = require('node-pushover-client');

var APP_TOKEN = 'apptoken';

var userTokens = {
  'username': 'usertoken'
};

var LocalLogger = function() {
  var self = this;

  self.summonMessageListener = function(nick, text, message) {
    var client = this;

    var split = text.split(' ', 3);
    var command = split[0];
    var username = split[1];

    if(command == '!summon' && !username) {
      client.say(nick, 'Usage: !summon <username> [message]');

      return;
    }
    
    if(command == '!summon' && username && !userTokens[username]) {
      client.say(nick, 'Unknown username');

      return;
    }

    if(command == '!summon' && userTokens[username]) {
      var pushMessageText = text.substring((command + ' ' + username).length, text.length) || 'No message';
      
      client.say(nick, 'Summoning ' + username + '..');

      var pushNotification = new Pushover({
        token: APP_TOKEN,
        user: userTokens[username]
      });

      var req = pushNotification.send({ message: pushMessageText });

      req.then(function (res) {
        if(res && res.success) {
          client.say(nick, username + ' was summoned');
        }
        else {
          client.say(nick, 'There was an error summoning ' + username + ':');
          res.errors.forEach(function(error) {
            client.say(nick, '- ' + error);
          });
          console.log(res);
        }
      });

    }
  };


  /**
   * Unloads all listeners
  */
  self.unload = function(client) {
    client.removeListener('pm', self.summonMessageListener);
  };

  /**
   * Loads all listeners
  */
  self.load = function(client) {
    client.addListener('pm', self.summonMessageListener);
  };

};

module.exports = new LocalLogger();
